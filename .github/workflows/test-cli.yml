name: Test CLI

on: 
  push:
    branches:
      - main
      - startup-90-remove-workos-switch-to-better-auth
  pull_request:

jobs:
  test-cli:
    name: Test StartupKit CLI Project Generator
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9.6.0
          run_install: false
          
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Verify CLI binary exists
        run: |
          echo "ğŸ” Checking CLI binary..."
          if [ ! -f "packages/cli/dist/cli.js" ]; then
            echo "âŒ CLI binary not found at packages/cli/dist/cli.js"
            ls -la packages/cli/dist/
            exit 1
          fi
          echo "âœ… CLI binary exists"
          ls -la packages/cli/dist/cli.js

          echo "ğŸ” Testing CLI help command..."
          if ! node packages/cli/dist/cli.js --help; then
            echo "âŒ CLI help command failed"
            exit 1
          fi
          echo "âœ… CLI help command successful"

      - name: Create test directory
        run: mkdir -p test-projects

      - name: Test CLI help (no args)
        run: |
          echo "ğŸ” Testing CLI without arguments..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js"; then
            echo "âŒ CLI should show help when no arguments provided"
            exit 1
          fi
          echo "âœ… CLI help displayed successfully"
        working-directory: test-projects

      - name: Test project initialization with specific name
        run: |
          echo "ğŸ” Testing project initialization with name 'test-startup'..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "test-startup" --repo "ian/startupkit/templates/repo"; then
            echo "âŒ Project initialization failed"
            exit 1
          fi
          echo "âœ… Project created successfully"
        working-directory: test-projects

      - name: Verify project structure
        run: |
          echo "ğŸ” Verifying project structure for 'test-startup'..."

          echo "ğŸ“‚ Checking project root directory..."
          if [ ! -d "test-startup" ]; then
            echo "âŒ Project directory 'test-startup' not found"
            ls -la
            exit 1
          fi
          echo "âœ… Project directory exists"
          ls -la test-startup/

          echo "ğŸ“‚ Checking packages directory..."
          if [ ! -d "test-startup/packages" ]; then
            echo "âŒ packages directory not found"
            ls -la test-startup/
            exit 1
          fi
          echo "âœ… packages directory exists"

          echo "ğŸ“„ Checking required files..."

          required_files=(
            "package.json"
            "turbo.json"
            "pnpm-workspace.yaml"
            "biome.jsonc"
            "packages/db/package.json"
            "packages/auth/package.json"
            "packages/ui/package.json"
            "packages/utils/package.json"
            "packages/analytics/package.json"
            "packages/jobs/package.json"
            "packages/emails/package.json"
          )

          missing_files=()

          for file in "${required_files[@]}"; do
            if [ ! -f "test-startup/$file" ]; then
              missing_files+=("$file")
              echo "âŒ Missing: $file"
            else
              echo "âœ… Found: $file"
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ Missing files: ${missing_files[*]}"
            exit 1
          fi

          echo "âœ… All required files are present"
        working-directory: test-projects

      - name: Verify package.json content and PROJECT replacement
        run: |
          echo "ğŸ” Verifying package.json content..."
          cd test-startup

          echo "ğŸ“‹ Checking package.json exists and is valid JSON..."
          if ! cat package.json; then
            echo "âŒ Cannot read package.json"
            exit 1
          fi

          if ! node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"; then
            echo "âŒ package.json is not valid JSON"
            exit 1
          fi
          echo "âœ… package.json is valid JSON"

          echo "ğŸ” Checking that PROJECT was replaced with test-startup..."

          # Check name field in root package.json
          if ! grep -q '"name": "test-startup"' package.json; then
            echo "âŒ Expected name field 'test-startup' not found in root package.json"
            echo "Current name field:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).name)"
            exit 1
          fi
          echo "âœ… Root package.json name is correct: test-startup"

          # Verify PROJECT was replaced across all package.json files
          echo "ğŸ” Checking all package.json files for PROJECT replacement..."
          if grep -r "PROJECT" packages/*/package.json; then
            echo "âŒ Found unreplaced PROJECT in package.json files"
            exit 1
          fi
          echo "âœ… All PROJECT references have been replaced"
        working-directory: test-projects

      - name: Verify pnpm-workspace.yaml
        run: |
          echo "ğŸ” Verifying pnpm-workspace.yaml..."
          cd test-startup

          if [ ! -f "pnpm-workspace.yaml" ]; then
            echo "âŒ pnpm-workspace.yaml not found"
            exit 1
          fi

          echo "ğŸ“„ pnpm-workspace.yaml content:"
          cat pnpm-workspace.yaml

          if ! grep -q "packages:" pnpm-workspace.yaml; then
            echo "âŒ pnpm-workspace.yaml doesn't contain packages configuration"
            exit 1
          fi
          echo "âœ… pnpm-workspace.yaml is correctly configured"
        working-directory: test-projects

      - name: Install dependencies in generated project
        run: |
          echo "ğŸ“¦ Installing dependencies in generated project..."
          cd test-startup
          if ! pnpm install --frozen-lockfile; then
            echo "âš ï¸ frozen-lockfile failed, trying without..."
            if ! pnpm install; then
              echo "âŒ Failed to install dependencies"
              exit 1
            fi
          fi
          echo "âœ… Dependencies installed successfully"
        working-directory: test-projects

      - name: Test typecheck in generated project
        run: |
          echo "ğŸ” Running typecheck in generated project..."
          cd test-startup
          if ! pnpm typecheck; then
            echo "âŒ Typecheck failed"
            exit 1
          fi
          echo "âœ… Typecheck passed"
        working-directory: test-projects

      - name: Test build in generated project
        run: |
          echo "ğŸ—ï¸ Building generated project..."
          cd test-startup
          if ! pnpm build; then
            echo "âŒ Build failed"
            exit 1
          fi
          echo "âœ… Build successful"
        working-directory: test-projects

      - name: Test project with custom name and special characters
        run: |
          echo "ğŸ§ª Testing project creation with special characters..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "My Awesome Startup!" --repo "ian/startupkit/templates/repo"; then
            echo "âŒ Failed to create project with special characters"
            exit 1
          fi

          if [ ! -d "my-awesome-startup" ]; then
            echo "âŒ Expected directory 'my-awesome-startup' not found"
            ls -la | grep "^d"
            exit 1
          fi
          echo "âœ… Directory created with sanitized name"

          echo "ğŸ” Checking package.json name field..."
          if ! grep -q '"name": "my-awesome-startup"' my-awesome-startup/package.json; then
            echo "âŒ Package.json name not sanitized correctly"
            echo "Current name:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('my-awesome-startup/package.json', 'utf8')).name)"
            exit 1
          fi
          echo "âœ… Package.json name correctly sanitized"
        working-directory: test-projects

      - name: Verify Prisma schema
        run: |
          echo "ğŸ” Verifying Prisma schema..."
          cd test-startup

          if [ ! -f "packages/db/prisma/schema.prisma" ]; then
            echo "âŒ Prisma schema not found"
            exit 1
          fi
          echo "âœ… Prisma schema exists"

          echo "ğŸ“„ Checking schema content..."
          if ! grep -q "datasource" packages/db/prisma/schema.prisma; then
            echo "âŒ Prisma schema appears to be invalid"
            exit 1
          fi
          echo "âœ… Prisma schema is valid"
        working-directory: test-projects

      - name: Verify auth package structure
        run: |
          echo "ğŸ” Verifying auth package structure..."
          cd test-startup

          if [ ! -f "packages/auth/src/lib/auth.ts" ]; then
            echo "âŒ Auth library not found"
            exit 1
          fi
          echo "âœ… Auth library exists"

          if [ ! -f "packages/auth/src/components/provider.tsx" ]; then
            echo "âŒ Auth provider not found"
            exit 1
          fi
          echo "âœ… Auth provider exists"
        working-directory: test-projects

      - name: Test add command (add Next.js app)
        run: |
          echo "ğŸ” Testing add command to add a new Next.js app..."
          cd test-startup
          
          # Test adding a new Next.js app
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" add next --name "web"; then
            echo "âŒ Failed to add Next.js app"
            exit 1
          fi

          if [ ! -d "apps/web" ]; then
            echo "âŒ apps/web directory not created"
            ls -la apps/
            exit 1
          fi
          echo "âœ… Next.js app 'web' added successfully"

          if [ ! -f "apps/web/package.json" ]; then
            echo "âŒ apps/web/package.json not found"
            exit 1
          fi
          echo "âœ… apps/web/package.json exists"
        working-directory: test-projects

      - name: Clean up test projects
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up test projects..."
          rm -rf test-projects
          echo "âœ… Cleanup complete"

  test-cli-comprehensive:
    name: CLI Edge Cases and Validation
    runs-on: ubuntu-latest
    needs: test-cli

    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9.6.0
          run_install: false
          
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Create test environment
        run: mkdir -p /tmp/cli-edge-cases

      - name: Test multiple projects in sequence
        run: |
          echo "ğŸ” Testing creation of multiple projects..."
          
          for project in "project-one" "project-two" "project-three"; do
            echo "ğŸ“ Creating $project..."
            if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "$project" --repo "ian/startupkit/templates/repo"; then
              echo "âŒ Failed to create $project"
              exit 1
            fi
            
            if [ ! -d "$project" ]; then
              echo "âŒ Directory $project not found"
              exit 1
            fi
            echo "âœ… $project created successfully"
          done
          
          echo "âœ… All projects created successfully"
        working-directory: /tmp/cli-edge-cases

      - name: Test project names with various formats
        run: |
          echo "ğŸ” Testing various project name formats..."
          
          test_cases=(
            "simple:simple"
            "With Spaces:with-spaces"
            "UPPERCASE:uppercase"
            "kebab-case:kebab-case"
            "snake_case:snake-case"
            "123-numbers:123-numbers"
          )
          
          for test_case in "${test_cases[@]}"; do
            input="${test_case%%:*}"
            expected="${test_case##*:}"
            
            echo "ğŸ“ Testing: '$input' -> '$expected'"
            if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "$input" --repo "ian/startupkit/templates/repo"; then
              echo "âŒ Failed to create project with name '$input'"
              exit 1
            fi
            
            if [ ! -d "$expected" ]; then
              echo "âŒ Expected directory '$expected' not found"
              echo "Available directories:"
              ls -la | grep "^d"
              exit 1
            fi
            
            echo "âœ… Successfully created '$expected' from '$input'"
          done
        working-directory: /tmp/cli-edge-cases

      - name: Verify no template artifacts remain
        run: |
          echo "ğŸ” Checking for unwanted template artifacts..."
          cd simple
          
          # Check for any remaining template placeholders
          if grep -r "PLACEHOLDER" . --exclude-dir=node_modules 2>/dev/null; then
            echo "âš ï¸ Found PLACEHOLDER text in generated project"
          fi
          
          # Check for .git directory (should not be copied)
          if [ -d ".git" ]; then
            echo "âŒ .git directory should not be present in generated project"
            exit 1
          fi
          echo "âœ… No .git directory (correct)"
          
          echo "âœ… No unwanted template artifacts found"
        working-directory: /tmp/cli-edge-cases

      - name: Test CLI version display
        run: |
          echo "ğŸ” Testing CLI version display..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" --help | grep -i "startupkit"; then
            echo "âš ï¸ Version or name not displayed in help"
          else
            echo "âœ… CLI displays name in help"
          fi

      - name: Clean up edge case tests
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up edge case tests..."
          rm -rf /tmp/cli-edge-cases
          echo "âœ… Cleanup complete"

  test-cli-summary:
    name: CLI Testing Summary
    runs-on: ubuntu-latest
    needs: [test-cli, test-cli-comprehensive]
    if: always()

    steps:
      - name: Display test summary
        run: |
          echo "ğŸ‰ CLI Testing Complete"
          echo ""
          echo "ğŸ“Š Test Results Summary:"
          echo "  - Basic CLI tests: ${{ needs.test-cli.result }}"
          echo "  - Edge case tests: ${{ needs.test-cli-comprehensive.result }}"
          echo ""
          if [ "${{ needs.test-cli.result }}" = "success" ] && [ "${{ needs.test-cli-comprehensive.result }}" = "success" ]; then
            echo "âœ… All CLI tests passed successfully!"
            exit 0
          else
            echo "âŒ Some CLI tests failed. Please review the logs above."
            exit 1
          fi

