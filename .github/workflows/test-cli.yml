name: Test CLI

on: 
  push:
    branches:
      - main
  pull_request:

jobs:
  test-cli:
    name: CLI Project Generator
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9.6.0
          run_install: false
          
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build all packages
        run: pnpm build

      - name: Verify CLI build output
        run: |
          echo "ğŸ“¦ Checking CLI build output..."
          echo "Contents of packages/cli/dist/:"
          ls -lah packages/cli/dist/ || echo "Directory does not exist"
          echo ""
          echo "Contents of packages/cli/src/:"
          ls -lah packages/cli/src/
          echo ""
          echo "ğŸ” Checking CLI dist files in detail..."
          find packages/cli/dist -type f -exec ls -lh {} \;

      - name: Verify CLI binary exists
        run: |
          echo "ğŸ” Checking CLI binary..."
          if [ ! -f "packages/cli/dist/cli.js" ]; then
            echo "âŒ CLI binary not found at packages/cli/dist/cli.js"
            echo "Available files in packages/cli/dist/:"
            ls -la packages/cli/dist/
            echo ""
            echo "CLI package.json exports:"
            cat packages/cli/package.json | grep -A 10 '"exports"'
            exit 1
          fi
          echo "âœ… CLI binary exists"
          ls -la packages/cli/dist/cli.js
          
          echo ""
          echo "ğŸ” Testing CLI help command..."
          set -x
          node packages/cli/dist/cli.js --help 2>&1 || true
          set +x
          if ! node packages/cli/dist/cli.js --help 2>&1 | head -20; then
            echo "âŒ CLI help command failed"
            exit 1
          fi
          echo "âœ… CLI help command successful"

      - name: Create test directory
        run: mkdir -p test-projects

      - name: Test CLI help (no args)
        run: |
          echo "ğŸ” Testing CLI without arguments..."
          set -x
          node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" 2>&1 || true
          set +x
          echo "âœ… CLI help displayed successfully"
        working-directory: test-projects

      - name: Test project initialization with specific name
        run: |
          echo "ğŸ” Testing project initialization with name 'test-startup'..."
          echo "Current directory: $(pwd)"
          echo "Available space: $(df -h . | tail -1)"
          echo "Current branch: ${{ github.ref_name }}"
          
          set -x
          node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "test-startup" --repo "ian/startupkit#${{ github.ref_name }}" 2>&1 || EXIT_CODE=$?
          set +x
          
          if [ -n "$EXIT_CODE" ]; then
            echo "âŒ Project initialization failed with exit code $EXIT_CODE"
            echo ""
            echo "Contents of test-projects directory:"
            ls -lah
            exit 1
          fi
          echo "âœ… Project created successfully"
        working-directory: test-projects

      - name: Verify project structure
        run: |
          echo "ğŸ” Verifying project structure for 'test-startup'..."

          echo "ğŸ“‚ Checking project root directory..."
          if [ ! -d "test-startup" ]; then
            echo "âŒ Project directory 'test-startup' not found"
            echo "Current directory contents:"
            pwd
            ls -la
            exit 1
          fi
          echo "âœ… Project directory exists"
          ls -lah test-startup/

          echo "ğŸ“‚ Checking packages directory..."
          if [ ! -d "test-startup/packages" ]; then
            echo "âŒ packages directory not found"
            echo "test-startup contents:"
            ls -lah test-startup/
            exit 1
          fi
          echo "âœ… packages directory exists"

          echo "ğŸ“„ Checking required files..."

          required_files=(
            "package.json"
            "turbo.json"
            "pnpm-workspace.yaml"
            "biome.jsonc"
            "packages/db/package.json"
            "packages/auth/package.json"
            "packages/ui/package.json"
            "packages/utils/package.json"
            "packages/analytics/package.json"
            "packages/emails/package.json"
          )

          missing_files=()

          for file in "${required_files[@]}"; do
            if [ ! -f "test-startup/$file" ]; then
              missing_files+=("$file")
              echo "âŒ Missing: $file"
            else
              echo "âœ… Found: $file"
            fi
          done

          if [ ${#missing_files[@]} -gt 0 ]; then
            echo "âŒ Missing files: ${missing_files[*]}"
            echo ""
            echo "Full directory tree of test-startup:"
            find test-startup -type f | head -50
            exit 1
          fi

          echo "âœ… All required files are present"
        working-directory: test-projects

      - name: Verify package.json content and PROJECT replacement
        run: |
          echo "ğŸ” Verifying package.json content..."
          cd test-startup

          echo "ğŸ“‹ Checking package.json exists and is valid JSON..."
          if ! cat package.json; then
            echo "âŒ Cannot read package.json"
            exit 1
          fi

          if ! node -e "JSON.parse(require('fs').readFileSync('package.json', 'utf8'))"; then
            echo "âŒ package.json is not valid JSON"
            cat package.json
            exit 1
          fi
          echo "âœ… package.json is valid JSON"

          echo "ğŸ” Checking that PROJECT was replaced with test-startup..."

          # Check name field in root package.json
          actual_name=$(node -e "console.log(JSON.parse(require('fs').readFileSync('package.json', 'utf8')).name)")
          echo "Actual name: $actual_name"
          
          if [ "$actual_name" != "test-startup" ]; then
            echo "âŒ Expected name field 'test-startup' but got '$actual_name'"
            exit 1
          fi
          echo "âœ… Root package.json name is correct: test-startup"

          # Verify PROJECT was replaced across all package.json files
          echo "ğŸ” Checking all package.json files for PROJECT replacement..."
          if grep -r "PROJECT" packages/*/package.json 2>/dev/null; then
            echo "âŒ Found unreplaced PROJECT in package.json files"
            exit 1
          fi
          echo "âœ… All PROJECT references have been replaced"
        working-directory: test-projects

      - name: Verify pnpm-workspace.yaml
        run: |
          echo "ğŸ” Verifying pnpm-workspace.yaml..."
          cd test-startup

          if [ ! -f "pnpm-workspace.yaml" ]; then
            echo "âŒ pnpm-workspace.yaml not found"
            exit 1
          fi

          echo "ğŸ“„ pnpm-workspace.yaml content:"
          cat pnpm-workspace.yaml

          if ! grep -q "packages:" pnpm-workspace.yaml; then
            echo "âŒ pnpm-workspace.yaml doesn't contain packages configuration"
            exit 1
          fi
          echo "âœ… pnpm-workspace.yaml is correctly configured"
        working-directory: test-projects

      - name: Link local packages for testing
        run: |
          echo "Adding pnpm overrides to use local packages..."
          cd test-startup
          node -e "
          const fs = require('fs');
          const workspace = process.env.GITHUB_WORKSPACE;
          const pkg = JSON.parse(fs.readFileSync('package.json', 'utf8'));
          pkg.pnpm = pkg.pnpm || {};
          pkg.pnpm.overrides = {
            '@startupkit/auth': 'link:' + workspace + '/packages/auth',
            '@startupkit/analytics': 'link:' + workspace + '/packages/analytics',
            '@startupkit/utils': 'link:' + workspace + '/packages/utils'
          };
          fs.writeFileSync('package.json', JSON.stringify(pkg, null, 2));
          console.log('Overrides added:', pkg.pnpm.overrides);
          "
          cat package.json | grep -A 6 '"pnpm"'
        working-directory: test-projects

      - name: Install dependencies in generated project
        run: |
          echo "ğŸ“¦ Installing dependencies in generated project..."
          cd test-startup
          echo "Removing existing lockfile to regenerate with overrides..."
          rm -rf node_modules pnpm-lock.yaml
          
          echo "ğŸ” Running pnpm install with verbose output..."
          set -x
          pnpm install 2>&1 || EXIT_CODE=$?
          set +x
          
          if [ -n "$EXIT_CODE" ]; then
            echo "âŒ Failed to install dependencies (exit code: $EXIT_CODE)"
            echo ""
            echo "pnpm list output:"
            pnpm list 2>&1 || true
            exit 1
          fi
          echo "âœ… Dependencies installed successfully"
        working-directory: test-projects

      - name: Test typecheck in generated project
        run: |
          echo "ğŸ” Running typecheck in generated project..."
          cd test-startup
          set -x
          pnpm typecheck 2>&1 || EXIT_CODE=$?
          set +x
          
          if [ -n "$EXIT_CODE" ]; then
            echo "âŒ Typecheck failed (exit code: $EXIT_CODE)"
            exit 1
          fi
          echo "âœ… Typecheck passed"
        working-directory: test-projects

      - name: Test build in generated project
        run: |
          echo "ğŸ—ï¸ Building generated project..."
          cd test-startup
          set -x
          pnpm build 2>&1 || EXIT_CODE=$?
          set +x
          
          if [ -n "$EXIT_CODE" ]; then
            echo "âŒ Build failed (exit code: $EXIT_CODE)"
            exit 1
          fi
          echo "âœ… Build successful"
        working-directory: test-projects

      - name: Test project with custom name and special characters
        run: |
          echo "ğŸ§ª Testing project creation with special characters..."
          set -x
          node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "My Awesome Startup!" --repo "ian/startupkit#${{ github.ref_name }}" 2>&1 || EXIT_CODE=$?
          set +x
          
          if [ -n "$EXIT_CODE" ]; then
            echo "âŒ Failed to create project with special characters (exit code: $EXIT_CODE)"
            exit 1
          fi

          if [ ! -d "my-awesome-startup" ]; then
            echo "âŒ Expected directory 'my-awesome-startup' not found"
            echo "Available directories:"
            ls -la | grep "^d"
            exit 1
          fi
          echo "âœ… Directory created with sanitized name"

          echo "ğŸ” Checking package.json name field..."
          if ! grep -q '"name": "my-awesome-startup"' my-awesome-startup/package.json; then
            echo "âŒ Package.json name not sanitized correctly"
            echo "Current name:"
            node -e "console.log(JSON.parse(require('fs').readFileSync('my-awesome-startup/package.json', 'utf8')).name)"
            exit 1
          fi
          echo "âœ… Package.json name correctly sanitized"
        working-directory: test-projects

      - name: Verify Drizzle schema
        run: |
          echo "ğŸ” Verifying Drizzle schema..."
          cd test-startup

          if [ ! -f "packages/db/src/schema.ts" ]; then
            echo "âŒ Drizzle schema not found"
            exit 1
          fi
          echo "âœ… Drizzle schema exists"

          echo "ğŸ“„ Checking schema content..."
          if ! grep -q "pgTable" packages/db/src/schema.ts; then
            echo "âŒ Drizzle schema appears to be invalid"
            exit 1
          fi
          echo "âœ… Drizzle schema is valid"

          echo "ğŸ“„ Checking Drizzle config..."
          if [ ! -f "packages/db/drizzle.config.ts" ]; then
            echo "âŒ Drizzle config not found"
            exit 1
          fi
          echo "âœ… Drizzle config exists"
        working-directory: test-projects

      - name: Verify auth package structure
        run: |
          echo "ğŸ” Verifying auth package structure..."
          cd test-startup

          if [ ! -f "packages/auth/src/lib/auth.ts" ]; then
            echo "âŒ Auth library not found"
            exit 1
          fi
          echo "âœ… Auth library exists"

          if [ ! -f "packages/auth/src/components/provider.tsx" ]; then
            echo "âŒ Auth provider not found"
            exit 1
          fi
          echo "âœ… Auth provider exists"
        working-directory: test-projects

      - name: Test add command (add Next.js app)
        run: |
          echo "ğŸ” Testing add command to add a new Next.js app..."
          cd test-startup
          
          # Test adding a new Next.js app
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" add next --name "web"; then
            echo "âŒ Failed to add Next.js app"
            exit 1
          fi

          if [ ! -d "apps/web" ]; then
            echo "âŒ apps/web directory not created"
            ls -la apps/
            exit 1
          fi
          echo "âœ… Next.js app 'web' added successfully"

          if [ ! -f "apps/web/package.json" ]; then
            echo "âŒ apps/web/package.json not found"
            exit 1
          fi
          echo "âœ… apps/web/package.json exists"
        working-directory: test-projects

      - name: Clean up test projects
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up test projects..."
          rm -rf test-projects
          echo "âœ… Cleanup complete"

      - name: Debug info on failure
        if: failure()
        run: |
          echo "ğŸ” Debug Information (on failure)"
          echo ""
          echo "Node version:"
          node --version
          echo ""
          echo "pnpm version:"
          pnpm --version
          echo ""
          echo "CLI package.json:"
          cat packages/cli/package.json
          echo ""
          echo "CLI source files:"
          ls -lah packages/cli/src/
          echo ""
          echo "CLI dist files:"
          ls -lah packages/cli/dist/ || echo "dist directory does not exist"

  test-cli-edge-cases:
    name: CLI Edge Cases and Validation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9.6.0
          run_install: false
          
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Create test environment
        run: mkdir -p /tmp/cli-edge-cases

      - name: Test multiple projects in sequence
        run: |
          echo "ğŸ” Testing creation of multiple projects..."
          
          for project in "project-one" "project-two" "project-three"; do
            echo "ğŸ“ Creating $project..."
            if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "$project" --repo "ian/startupkit#${{ github.ref_name }}"; then
              echo "âŒ Failed to create $project"
              exit 1
            fi
            
            if [ ! -d "$project" ]; then
              echo "âŒ Directory $project not found"
              exit 1
            fi
            echo "âœ… $project created successfully"
          done
          
          echo "âœ… All projects created successfully"
        working-directory: /tmp/cli-edge-cases

      - name: Test project names with various formats
        run: |
          echo "ğŸ” Testing various project name formats..."
          
          test_cases=(
            "simple:simple"
            "With Spaces:with-spaces"
            "UPPERCASE:uppercase"
            "kebab-case:kebab-case"
            "snake_case:snake-case"
            "123-numbers:123-numbers"
          )
          
          for test_case in "${test_cases[@]}"; do
            input="${test_case%%:*}"
            expected="${test_case##*:}"
            
            echo "ğŸ“ Testing: '$input' -> '$expected'"
            if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "$input" --repo "ian/startupkit#${{ github.ref_name }}"; then
              echo "âŒ Failed to create project with name '$input'"
              exit 1
            fi
            
            if [ ! -d "$expected" ]; then
              echo "âŒ Expected directory '$expected' not found"
              echo "Available directories:"
              ls -la | grep "^d"
              exit 1
            fi
            
            echo "âœ… Successfully created '$expected' from '$input'"
          done
        working-directory: /tmp/cli-edge-cases

      - name: Verify no template artifacts remain
        run: |
          echo "ğŸ” Checking for unwanted template artifacts..."
          cd simple
          
          # Check for any remaining template placeholders
          if grep -r "PLACEHOLDER" . --exclude-dir=node_modules 2>/dev/null; then
            echo "âš ï¸ Found PLACEHOLDER text in generated project"
          fi
          
          # Check for .git directory (should not be copied)
          if [ -d ".git" ]; then
            echo "âŒ .git directory should not be present in generated project"
            exit 1
          fi
          echo "âœ… No .git directory (correct)"
          
          echo "âœ… No unwanted template artifacts found"
        working-directory: /tmp/cli-edge-cases

      - name: Test CLI version display
        run: |
          echo "ğŸ” Testing CLI version display..."
          if ! node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" --help | grep -i "startupkit"; then
            echo "âš ï¸ Version or name not displayed in help"
          else
            echo "âœ… CLI displays name in help"
          fi

      - name: Clean up edge case tests
        if: always()
        run: |
          echo "ğŸ§¹ Cleaning up edge case tests..."
          rm -rf /tmp/cli-edge-cases
          echo "âœ… Cleanup complete"

  test-cli-summary:
    name: CLI Testing Summary
    runs-on: ubuntu-latest
    needs: [test-cli, test-cli-edge-cases]
    if: always()

    steps:
      - name: Display test summary
        run: |
          echo "ğŸ‰ CLI Testing Complete"
          echo ""
          echo "ğŸ“Š Test Results Summary:"
          echo "  - Basic CLI tests: ${{ needs.test-cli.result }}"
          echo "  - Edge case tests: ${{ needs.test-cli-edge-cases.result }}"
          echo ""
          if [ "${{ needs.test-cli.result }}" = "success" ] && [ "${{ needs.test-cli-edge-cases.result }}" = "success" ]; then
            echo "âœ… All CLI tests passed successfully!"
            exit 0
          else
            echo "âŒ Some CLI tests failed. Please review the logs above."
            exit 1
          fi

