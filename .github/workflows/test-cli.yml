name: Test CLI

on: 
  push:
    branches:
      - main
  pull_request:

jobs:
  test-cli:
    name: CLI Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9.6.0
          run_install: false
          
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build CLI package
        run: pnpm --filter startupkit build

      - name: Run Vitest tests
        run: pnpm --filter startupkit test

      - name: Run Vitest tests with coverage
        run: pnpm --filter startupkit test:coverage

  test-cli-integration:
    name: CLI Integration - Full Build & Deploy
    runs-on: ubuntu-latest
    needs: test-cli

    steps:
      - uses: actions/checkout@v4
      
      - uses: pnpm/action-setup@v4
        with:
          version: 9.6.0
          run_install: false
          
      - uses: actions/setup-node@v4
        with:
          node-version: "22"
          cache: "pnpm"

      - name: Install dependencies and build
        run: |
          pnpm install --frozen-lockfile
          pnpm build

      - name: Create and test full project
        run: |
          mkdir -p test-projects
          cd test-projects
          
          echo "ğŸ” Creating full project with init command..."
          node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" init --name "test-startup" --repo "ian/startupkit#${{ github.ref_name }}"
          
          echo "ğŸ“‚ Verifying packages directory exists..."
          test -d test-startup/packages || exit 1
          
          echo "ğŸ“¦ Installing dependencies..."
          cd test-startup
          pnpm install --no-frozen-lockfile
          
          echo "ğŸ” Running typecheck..."
          pnpm typecheck
          
          echo "ğŸ—ï¸ Running build..."
          pnpm build
          
          echo "âœ… Full integration test passed"

      - name: Test add command
        run: |
          cd test-projects/test-startup
          
          echo "ğŸ” Testing add command..."
          node "$GITHUB_WORKSPACE/packages/cli/dist/cli.js" add next --name "web" --repo "ian/startupkit/templates/apps/next#${{ github.ref_name }}"
          
          test -d apps/web || exit 1
          test -f apps/web/package.json || exit 1
          
          echo "âœ… Add command test passed"

      - name: Clean up
        if: always()
        run: rm -rf test-projects

