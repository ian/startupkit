#!/bin/bash

# Default to patch if no argument is provided
VERSION_TYPE=${1:-patch}

# Validate input
if [[ "$VERSION_TYPE" != "patch" && "$VERSION_TYPE" != "minor" && "$VERSION_TYPE" != "major" ]]; then
    echo "Invalid version type. Use 'patch', 'minor', or 'major'."
    exit 1
fi

# Execute the bump command
pnpm recursive --filter "./packages/**" exec -- npm version "$VERSION_TYPE"

# Get the bumped version number
BUMPED_VERSION=$(pnpm recursive --filter "./packages/**" exec -- node -p "require('./package.json').version" | uniq)

# Update template files to reference the new version
echo "Updating template references to version $BUMPED_VERSION..."

# Find all package.json files in templates and update @startupkit/* package references
find templates -path "*/node_modules" -prune -o -name "package.json" -type f -print | while read -r template_file; do
    if grep -q "@startupkit/" "$template_file"; then
        # Update each @startupkit package reference with the new version
        sed -i '' -E "s/(\"@startupkit\/[^\"]+\": \")(\^)?[0-9]+\.[0-9]+\.[0-9]+(\",?)/\1\2$BUMPED_VERSION\3/g" "$template_file"
        echo "  Updated $template_file"
    fi
done

git add .
git ci -am"chore: bump version to $BUMPED_VERSION"

git tag "v$BUMPED_VERSION"
git push
git push --tags

echo ""
echo "Bumped version to $BUMPED_VERSION"